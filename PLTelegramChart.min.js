class PLTelegramChart{constructor(t){this.defaults={color:"#333",exceptionKeys:["x"],months:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],days:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],canvas:{width:600,height:400,darkMode:!1,controlsWidth:6}},this.formatData(t.data),this.chart=t.chart||this.defaults.canvas,this.index=t.index||0,this.touches=[],this.points={},this.parentElementId=t.parentElementId,this.checkBoxes=Object.keys(this.data),this.excludedKeys=[],this.lastX=0,this._markers={start:0,end:1},this.setStrategies(),this.overrideMethodsForExcludedKeys()}set markers(t){this._markers=t,this.drawChart()}get markers(){return this._markers}set darkMode(t){this.chart.darkMode=t,this.setStyles(),this.drawBackground(),this.drawChart()}get darkMode(){return this.chart.darkMode}overrideMethodsForExcludedKeys(){Object.defineProperty(this.excludedKeys,"push",{enumerable:!1,value:t=>{Array.prototype.push.apply(this.excludedKeys,[t]),this.drawChart(),this.drawBackground(),this.showPoint()}}),Object.defineProperty(this.excludedKeys,"splice",{enumerable:!1,value:(t,e)=>{Array.prototype.splice.apply(this.excludedKeys,[t,e]),this.drawChart(),this.drawBackground(),this.showPoint()}})}setStrategies(){let t=this.chart.width,e=2*this.chart.controlsWidth/t;this.strategies={},this.strategies[`rightSubControl_${this.index}`]=(t=>{let i=this.getXAcrossEvents(t);this.markers.start<this.markers.end-2*e?this.decreaseWidth(`rightControl_${this.index}`,i):i<0?this.markers.start>0&&(this.decreaseWidth(`rightControl_${this.index}`,i),this.increaseWidth(`leftControl_${this.index}`,i)):this.decreaseWidth(`rightControl_${this.index}`,i)}),this.strategies[`leftSubControl_${this.index}`]=(t=>{let i=this.getXAcrossEvents(t);this.markers.start<this.markers.end-2*e?this.increaseWidth(`leftControl_${this.index}`,i):i>0?this.markers.end<1&&(this.decreaseWidth(`rightControl_${this.index}`,i),this.increaseWidth(`leftControl_${this.index}`,i)):this.increaseWidth(`leftControl_${this.index}`,i)}),this.strategies[`range_${this.index}`]=(t=>{let i=this.getXAcrossEvents(t);(this.markers.start-e/6>0&&i<0||this.markers.end+e/6<1&&i>0)&&(this.increaseWidth(`leftControl_${this.index}`,i),this.decreaseWidth(`rightControl_${this.index}`,i))})}getStrategy(t){let e=t.getAttribute("id");return this.strategies[e]}getXAcrossEvents(t){let e=t.movementX||0;if(!e&&e!==0){let t=event.touches[0]||event.changedTouches[0];this.touches.length?(e=t.clientX-this.touches[0],this.touches[0]=t.clientX):(this.touches.push(t.clientX),e=0)}return e}formatData(t){let e={};t.columns.map(i=>{let n=i.splice(0,1)[0];e[n]={data:i,color:t.colors[n]||this.defaults.color,type:t.types[n]}}),this.data=e}getCheckBoxesTemplate(){let t="";return this.checkBoxes.map(e=>{this.defaults.exceptionKeys.includes(e)||(t+=`<style>\n #checkbox_${e}_${this.index}:checked + label {\n background-color: ${this.data[e].color};\n border-color: ${this.data[e].color};\n }\n </style>\n <div class="round">\n <input id="checkbox_${e}_${this.index}" type="checkbox" checked="${!this.excludedKeys.includes(e)}">\n <label for="checkbox_${e}_${this.index}"></label>\n <span>${e}</span>\n </div>`)}),t}getStyles(){return`<style id="style_${this.index}">\n #chart_${this.index} {\n border-top-left-radius: 18px;\n border-top-right-radius: 18px;\n }\n #Chart_${this.index}.chart {\n margin: 20px 0;\n width: ${this.chart.width}px;\n background-color: ${this.chart.darkMode?"#111":"#fff"};\n padding: 20px;\n border-radius: 20px;\n }\n #Chart_${this.index} .range {\n height: 40px;\n background: ${this.chart.darkMode?"#111":"#fff"};\n cursor: move;\n border: 1px solid ${this.chart.darkMode?"#bbb":"#444"};\n }\n #Chart_${this.index} .leftControl {\n height: 40px;\n background-color: ${this.chart.darkMode?"#333":"#ccc"};\n opacity: 0.75;\n float: left;\n cursor: auto;\n text-align: center;\n font-size: 10px;\n font-weight: bold;\n color: ${this.chart.darkMode?"#eee":"#111"};\n line-height: 40px;\n }\n #Chart_${this.index} .leftSubControl {\n width: ${this.chart.controlsWidth}px;\n height: 40px;\n background-color: ${this.chart.darkMode?"#bbb":"#444"};\n opacity: 0.95;\n float: left;\n cursor: w-resize;\n z-index: 999;\n }\n #Chart_${this.index} .rightControl {\n height: 40px;\n background-color: ${this.chart.darkMode?"#333":"#ccc"};\n opacity: 0.75;\n float: right;\n cursor: auto;\n text-align: center;\n font-size: 10px;\n font-weight: bold;\n color: ${this.chart.darkMode?"#eee":"#111"};\n line-height: 40px;\n }\n #Chart_${this.index} .rightSubControl {\n width: ${this.chart.controlsWidth}px;\n height: 40px;\n background-color: ${this.chart.darkMode?"#bbb":"#444"};\n opacity: 0.95;\n float: right;\n cursor: e-resize;\n z-index: 999;\n }\n #Chart_${this.index} .canvas {\n border: 1px solid ${this.chart.darkMode?"#bbb":"#444"};\n }\n #Chart_${this.index} .round {\n position: relative;\n display: inline-block;\n width: auto;\n border-radius: 20px;\n border: 1px solid ${this.chart.darkMode?"#333":"#ccc"};\n padding: 10px;\n height: 24px;\n }\n #Chart_${this.index} .checkboxHolder {\n margin-top: 18px;\n }\n#Chart_${this.index} .round label {\n background-color: ${this.chart.darkMode?"#111":"#fff"};\n border: 1px solid ${this.chart.darkMode?"#333":"#ccc"};\n border-radius: 50%;\n cursor: pointer;\n height: 28px;\n left: 7px;\n position: absolute;\n top: 7px;\n width: 28px;\n }\n#Chart_${this.index} .round label:after {\n border: 2px solid ${this.chart.darkMode?"#fff":"#111"};\n border-top: none;\n border-right: none;\n content: "";\n height: 6px;\n left: 7px;\n opacity: 0;\n position: absolute;\n top: 8px;\n transform: rotate(-45deg);\n width: 12px;\n }\n#Chart_${this.index} .round input[type="checkbox"] {\n visibility: hidden;\n }\n#Chart_${this.index} .round input[type="checkbox"]:checked + label:after {\n opacity: 1;\n }\n #Chart_${this.index} .round span {\n display: inline-block;\n min-width: 40px;\n margin-left: 10px;\n line-height: 24px;\n color: ${this.chart.darkMode?"#eee":"#333"}\n }\n #Chart_${this.index} #switcher_${this.index} {\n float: right;\n }\n #Chart_${this.index} #dates_holder_${this.index} {\n width: ${this.chart.width}px;\n height: 20px;\n cursor: pointer;\n}\n #Chart_${this.index} #pointShower_${this.index} {\n position: absolute;\n background: ${this.chart.darkMode?"#333":"#eee"};\n border-radius: 10px;\n border: 1px solid ${this.chart.darkMode?"#eee":"#333"};\n width: 90px;\n padding: 10px;\n }\n #pointShower_${this.index} .date {\n font-weight: bold;\n color: ${this.chart.darkMode?"#eee":"#333"}\n }\n </style>`}setStyles(){let t=document.getElementById(this.parentElementId),e=document.getElementById(`style_${this.index}`);t&&(this.styles=document.createElement("template"),this.styles.innerHTML=this.getStyles(),e?t.replaceChild(this.styles.content,e):t.appendChild(this.styles.content))}getTemplate(){return`<div class="chart" id="Chart_${this.index}">\n <canvas class="canvas" width="${this.chart.width}" height="${this.chart.height}" id="chart_${this.index}"></canvas>\n <div id="dates_holder_${this.index}"></div>\n <div class="range" id="range_${this.index}" style="width: ${this.chart.width}px;">\n <div class="leftControl" id="leftControl_${this.index}" style="width: ${Math.round(this.chart.width/4)}px;"></div>\n <div class="leftSubControl" id="leftSubControl_${this.index}"></div>\n <div class="rightControl" id="rightControl_${this.index}" style="width: ${Math.round(this.chart.width/4)}px;"></div>\n <div class="rightSubControl" id="rightSubControl_${this.index}"></div>\n </div>\n <div id="pointShower_${this.index}" draggable="true"></div>\n <div class="checkboxHolder">\n ${this.getCheckBoxesTemplate()}\n <div class="round" id="switcher_${this.index}">\n <input id="checkbox_mode_${this.index}" type="checkbox" checked="${this.darkMode}">\n <label for="checkbox_mode_${this.index}"></label>\n <span>DarkMode</span>\n </div>\n </div>\n </div>`}getPointTemplate(t){let e="<div>";for(let i in t)switch(i){case"left":case"top":break;case"x":let n=new Date(t[i]);e+=`<div class="date">${this.defaults.days[n.getDay()]}, ${n.getDate()} ${this.defaults.months[n.getMonth()]}</div>`;break;default:e+=`<div style="color: ${this.data[i].color}">${t[i]}</div>`}return e+="</div>"}decreaseWidth(t,e){let i=document.getElementById(t);if(i){let t=i.style.width||120;i.style.width=parseInt(t,10)-e+"px"}this.calculate()}increaseWidth(t,e){let i=document.getElementById(t);if(i){let t=i.style.width||120;i.style.width=parseInt(t,10)+e+"px"}this.calculate()}calculate(){let t=document.getElementById(`rightControl_${this.index}`),e=document.getElementById(`leftControl_${this.index}`),i=document.getElementById(`range_${this.index}`),n=parseInt(i.style.width,10),h=parseInt(e.style.width,10)/n,s=(n-parseInt(t.style.width,10))/n;this.markers={start:h,end:s},this.showPoint()}drawDates(){let t=document.getElementById(`dates_holder_${this.index}`),e=document.createElement("canvas"),{start:i,end:n}=this.markers,h=Math.round(i*this.data.x.data.length),s=Math.round(n*this.data.x.data.length),d=this.data.x.data,a=this.chart.width/(s-h),r=a*d.length;e.height=20,e.width=r;let o=e.getContext("2d");o.clearRect(0,0,e.width,e.height),this.chart.darkMode&&(o.fillStyle="#111",o.fillRect(0,0,e.width,e.height)),o.fillStyle=this.chart.darkMode?"#eee":"#333";let l=d.length,c=s-h,u=Math.round(2*e.height/3);for(let t=0;t<l;t++)if(t>=h&&t<=s){let e=Math.round(this.chart.width/40);if(c>e&&!(t%Math.ceil(c/e))||c<=e){let e=new Date(d[t]);o.fillText(`${e.getDate()} ${this.defaults.months[e.getMonth()]}`,a*t,u)}}t.style.background=`url(${e.toDataURL()})`,t.style["background-position"]=`left ${e.width*(1-i)}px top`;let p=document.getElementById(`leftControl_${this.index}`);p.innerText="",parseInt(p.style.width,10)>=70&&(p.innerText=`from ${new Date(d[h]).getDate()} ${this.defaults.months[new Date(d[h]).getMonth()]}`);let x=document.getElementById(`rightControl_${this.index}`);x.innerText="",parseInt(x.style.width,10)>=70&&(x.innerText=`to ${new Date(d[s]).getDate()} ${this.defaults.months[new Date(d[s]).getMonth()]}`)}drawChart(){let t=document.getElementById(`chart_${this.index}`),e=t.getContext("2d");e.clearRect(0,0,t.width,t.height);let i=[],n=[],h=Math.round(t.height/5);for(let t in this.data)if(!this.defaults.exceptionKeys.includes(t)&&!this.excludedKeys.includes(t)){let e=Math.max.apply(null,this.data[t].data),h=Math.min.apply(null,this.data[t].data);i.push(e),n.push(h)}let s=Math.max.apply(null,i),d=Math.min.apply(null,n);for(let i=0;i<t.height;i+=h)e.strokeStyle=this.chart.darkMode?"#333":"#eee",e.lineWidth=1,e.beginPath(),e.moveTo(0,t.height-i),e.lineTo(t.width,t.height-i),e.stroke(),e.closePath(),e.moveTo(0,t.height-i);if(Object.keys(this.data).length>this.excludedKeys.length+this.defaults.exceptionKeys.length){for(let i in this.data)if(!this.defaults.exceptionKeys.includes(i)&&!this.excludedKeys.includes(i)){let n=t.height/(s-d)*.9,{start:h,end:a}=this.markers;h=Math.round(h*this.data[i].data.length),a=Math.round(a*this.data[i].data.length);let r=[],o=this.data[i].data.slice(h,a),l=this.data.x.data.slice(h,a),c=t.width/l.length;for(let e=0;e<o.length;e++){let i={x:e===o.length-1?t.width:Math.round(c*e),y:t.height-Math.round(n*(o[e]-d))};r.push(i)}e.strokeStyle=this.chart.darkMode?"#333":"#eee",e.lineWidth=1,e.strokeStyle=this.data[i].color,e.lineWidth=1,e.moveTo(r[0].x,r[0].y),e.beginPath(),r.map(t=>{e.lineTo(t.x,t.y),e.stroke()}),e.closePath(),this.points[i]=r}for(let i=1;i<t.height;i+=h)e.fillStyle=this.chart.darkMode?"#eee":"#333",e.fillText(Math.round(s*(i+h)/t.height).toString(),20,t.height-i-h/2)}this.drawDates()}showPoint(t){let e=document.getElementById(`pointShower_${this.index}`);if(t){e.style.left=t.left+"px",e.style.top=t.top+"px";let i=document.createElement("template");i.innerHTML=this.getPointTemplate(t),e.innerHTML="",e.append(i.content),e.style.display="block"}else e.innerHTML="",e.style.display="none"}drawBackground(){let t=document.createElement("canvas");t.width=this.chart.width,t.height=40;let e=t.getContext("2d");e.clearRect(0,0,t.width,t.height);let i=[],n=[];if(Object.keys(this.data).length>this.excludedKeys.length+this.defaults.exceptionKeys.length){for(let t in this.data)if(!this.defaults.exceptionKeys.includes(t)&&!this.excludedKeys.includes(t)){let e=Math.max.apply(null,this.data[t].data),h=Math.min.apply(null,this.data[t].data);i.push(e),n.push(h)}for(let h in this.data)if(!this.defaults.exceptionKeys.includes(h)&&!this.excludedKeys.includes(h)){let s=Math.max.apply(null,i),d=Math.min.apply(null,n),a=t.height/(s-d)*.9,r=[],o=this.data[h].data,l=this.data.x.data,c=t.width/l.length;for(let e=0;e<o.length;e++){let i={x:Math.round(c*e),y:t.height-Math.round(a*(o[e]-d))};r.push(i)}e.strokeStyle=this.data[h].color,e.lineWidth=1,e.beginPath(),e.moveTo(r[0].x,r[0].y),r.map(t=>{e.lineTo(t.x,t.y),e.stroke()}),e.closePath()}}document.getElementById(`range_${this.index}`).style.background=`url(${t.toDataURL()})`}initEvents(){let t=document.getElementById(`range_${this.index}`),e=this;t.addEventListener("mousedown",function(i){i.preventDefault();let n=e.getStrategy(i.target);n&&(t.addEventListener("mousemove",n),t.addEventListener("mouseup",e=>{t.removeEventListener("mousemove",n)}),t.addEventListener("mouseleave",e=>{t.removeEventListener("mousemove",n)}))}),t.addEventListener("touchstart",function(i){i.preventDefault();let n=e.getStrategy(i.target);n&&(t.addEventListener("touchmove",n),t.addEventListener("touchend",e=>{t.removeEventListener("touchmove",n)}))}),this.checkBoxes.map(t=>{let i=document.getElementById(`checkbox_${t}_${this.index}`);if(i){let n=!0;i.addEventListener("change",function(i){n?e.excludedKeys.push(t):e.excludedKeys.splice(e.excludedKeys.indexOf(t),1),n=!n})}}),document.getElementById(`checkbox_mode_${this.index}`).addEventListener("change",function(t){e.darkMode=!e.darkMode,this.setAttribute("checked",e.darkMode.toString())});let i=document.getElementById(`chart_${this.index}`),n=i.getContext("2d");i.addEventListener("mousemove",function(t){t.preventDefault();let e=n.getImageData(t.offsetX,t.offsetY,1,1).data;e="#"+("0"+parseInt(e[1],10).toString(16)).slice(-2)+("0"+parseInt(e[2],10).toString(16)).slice(-2)+("0"+parseInt(e[3],10).toString(16)).slice(-2),i.style.cursor="#000000"!==e&&"#ffffff"!==e?"pointer":"default"}),i.addEventListener("click",function(t){if(t.preventDefault(),"pointer"===i.style.cursor){let n=t.clientX-i.offsetLeft,h=t.offsetY+i.offsetTop,{start:s,end:d}=e.markers,a=n/i.width*(d-s)+s,r={left:n,top:h},o=Math.round(e.data.x.data.length*a);for(let t in e.data)e.excludedKeys.includes(t)||(r[t]=e.data[t].data[o]);e.currentPoint=r,e.showPoint(r)}else e.showPoint()})}render(){let t=document.getElementById(this.parentElementId);t&&(this.template=document.createElement("template"),this.template.innerHTML=this.getTemplate(),this.setStyles(),t.appendChild(this.template.content),this.calculate(),this.initEvents(),this.drawBackground())}static factory(t,e){t.map((t,i)=>new PLTelegramChart({index:i,parentElementId:e.parentElementId,data:t,chart:{darkMode:e.chart.darkMode,width:e.chart.width,height:e.chart.height,controlsWidth:e.chart.controlsWidth}}).render())}}